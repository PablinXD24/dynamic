<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Island Spotify</title>
    <style>
        /* --- RESET E BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; text-decoration: none; }
        
        body {
            height: 100vh; width: 100vw; display: flex; justify-content: center; align-items: flex-start; padding-top: 20px;
            background: radial-gradient(circle at 50% 100%, #191414, #000); 
            overflow: hidden; color: white;
        }

        /* --- ILHA --- */
        .dynamic-island {
            background-color: #000; border-radius: 50px;
            width: 120px; height: 35px;
            position: relative; z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.5s cubic-bezier(0.5, 1.35, 0.4, 1.0);
            cursor: pointer; box-shadow: 0 0 20px rgba(0,0,0,0.6);
        }

        .dynamic-island:hover:not(.expanded) { transform: scale(1.02); }
        .dynamic-island.expanded { width: 380px; height: 110px; border-radius: 40px; cursor: default; }

        .content-wrapper {
            width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: opacity 0.2s;
            pointer-events: none; /* Bloqueia cliques quando fechado */
        }
        
        .dynamic-island.expanded .content-wrapper {
            opacity: 1; visibility: visible; transition: opacity 0.4s ease 0.2s;
            pointer-events: auto; /* Libera cliques quando aberto */
        }

        /* --- BOTÃO COMO LINK (SOLUÇÃO DEFINITIVA) --- */
        .login-btn {
            background-color: #1DB954; color: #000; padding: 10px 24px;
            border-radius: 20px; font-weight: 700; display: flex; align-items: center; gap: 8px; font-size: 14px;
            
            /* FORÇA BRUTA PARA O CLIQUE FUNCIONAR */
            position: relative;
            z-index: 9999; 
            pointer-events: auto !important;
            cursor: pointer;
        }
        .login-btn:hover { background-color: #1ed760; transform: scale(1.05); }

        /* --- PLAYER --- */
        .player-view { display: none; width: 100%; padding: 0 25px; align-items: center; justify-content: space-between; }
        .album-art { width: 60px; height: 60px; border-radius: 8px; background-color: #333; background-size: cover; background-position: center; }
        .track-info { flex: 1; margin: 0 15px; overflow: hidden; }
        .track-title { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .artist { color: #b3b3b3; font-size: 12px; }
        .controls { display: flex; gap: 15px; }
        .control-btn { background: none; border: none; cursor: pointer; color: white; padding: 5px; }
        .control-btn:hover { color: #1DB954; }
        .no-music { font-size: 12px; color: #777; display: none; }
    </style>
</head>
<body>

    <div class="dynamic-island" id="island">
        <div class="content-wrapper">
            
            <div id="loginSection">
                <a href="https://accounts.spotify.com/authorize?client_id=ff2d9d81535645d29d8ba470833a264d&redirect_uri=https%3A%2F%2Fpablinxd24.github.io%2Fdynamic%2F&scope=user-read-playback-state%20user-modify-playback-state%20user-read-currently-playing&response_type=token&show_dialog=true" 
                   class="login-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
                    Conectar Spotify
                </a>
            </div>

            <div id="playerSection" class="player-view">
                <div class="album-art" id="albumArt"></div>
                <div class="track-info">
                    <span class="track-title" id="trackTitle">...</span>
                    <span class="artist" id="artistName">...</span>
                </div>
                <div class="controls">
                    <button class="control-btn" id="btnPrev"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                    <button class="control-btn" id="btnToggle"><svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg></button>
                    <button class="control-btn" id="btnNext"><svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
                </div>
            </div>
            <div id="noMusicMsg" class="no-music">Toque algo no Spotify App</div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://api.spotify.com/v1'; // Endpoint Oficial Correto
        let accessToken = null;

        window.addEventListener('load', () => {
            // 1. Verifica se tem token na URL (volta do login)
            accessToken = getTokenFromUrl();

            if (accessToken) {
                // Se tem token, remove o login e mostra o player
                document.getElementById('island').classList.add('expanded');
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('playerSection').style.display = 'flex';
                
                fetchNowPlaying();
                setInterval(fetchNowPlaying, 4000);
            } else {
                // Se NÃO tem token, abre a ilha para mostrar o link
                document.getElementById('island').classList.add('expanded');
            }

            // 2. Clique da Ilha (apenas visual)
            document.getElementById('island').addEventListener('click', (e) => {
                // Se clicou no link ou botões, não faz nada com a ilha
                if(e.target.closest('a') || e.target.closest('button')) return;
                
                document.getElementById('island').classList.toggle('expanded');
            });

            // 3. Controles do Player
            document.getElementById('btnPrev').addEventListener('click', () => sendCommand('previous'));
            document.getElementById('btnNext').addEventListener('click', () => sendCommand('next'));
            document.getElementById('btnToggle').addEventListener('click', togglePlayback);
        });

        function getTokenFromUrl() {
            if (window.location.hash) {
                const hash = window.location.hash.substring(1).split('&').reduce((initial, item) => {
                    if (item) {
                        var parts = item.split('=');
                        initial[parts[0]] = decodeURIComponent(parts[1]);
                    }
                    return initial;
                }, {});
                window.location.hash = ''; 
                return hash.access_token;
            }
            return null;
        }

        async function fetchNowPlaying() {
            if (!accessToken) return;
            try {
                const response = await fetch(`${API_BASE}/me/player/currently-playing`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (response.status === 204 || response.status > 400) {
                    showNoMusicState();
                    return;
                }
                const data = await response.json();
                updateUI(data);
            } catch (e) { console.error("Erro Player:", e); }
        }

        function updateUI(data) {
            if (!data || !data.item) { showNoMusicState(); return; }
            document.getElementById('noMusicMsg').style.display = 'none';
            document.getElementById('playerSection').style.display = 'flex';

            document.getElementById('trackTitle').innerText = data.item.name;
            document.getElementById('artistName').innerText = data.item.artists.map(a => a.name).join(', ');
            document.getElementById('albumArt').style.backgroundImage = `url('${data.item.album.images[0].url}')`;

            const playBtn = document.getElementById('btnToggle');
            if (data.is_playing) {
                playBtn.innerHTML = '<svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
            } else {
                playBtn.innerHTML = '<svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
            }
        }

        function showNoMusicState() {
            document.getElementById('trackTitle').innerText = "Parado";
            document.getElementById('artistName').innerText = "Abra o Spotify";
            document.getElementById('albumArt').style.backgroundColor = '#333';
        }

        async function sendCommand(endpoint, method = 'POST') {
            if (!accessToken) return;
            try {
                await fetch(`${API_BASE}/me/player/${endpoint}`, {
                    method: method,
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                setTimeout(fetchNowPlaying, 500);
            } catch (e) { console.error(e); }
        }

        function togglePlayback() {
            const isPausedIcon = document.getElementById('btnToggle').innerHTML.includes('M6 19h4V5H6v14zm8-14v14h4V5h-4z');
            const cmd = isPausedIcon ? 'pause' : 'play';
            sendCommand(cmd, 'PUT');
        }
    </script>
</body>
</html>
